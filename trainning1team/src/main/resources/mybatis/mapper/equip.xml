<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bnksystem.trainning1team.mapper.EquipMapper">

    <!-- 장비 출납 현황 조회 / index 이후의 eq.id 이후 size 만큼 / 장비별 최신 출납 기록 반환 -->
    <select id="getRentalEquipList" resultType="com.bnksystem.trainning1team.dto.Equip.RentalStatusResponse">
        SELECT eq.id AS id, eq.serial_no AS serialNo, eq.eq_nm AS equipmentName, es.status_nm AS statusName, mb.emp_no AS employeeNo, er.reg_at AS regAt
        FROM tb_entry_exit_record er
        INNER JOIN tb_eq_status es ON er.status_id = es.id
        INNER JOIN tb_equipments eq ON eq.id = er.eq_id
        INNER JOIN tb_members mb ON er.member_id = mb.id
        WHERE (eq.serial_no, er.reg_at) IN (
        SELECT eq.serial_no, MAX(er.reg_at) AS max_reg_at
        FROM tb_entry_exit_record er
        INNER JOIN tb_eq_status es ON er.status_id = es.id
        INNER JOIN tb_equipments eq ON eq.id = er.eq_id
        INNER JOIN tb_members mb ON er.member_id = mb.id
        GROUP BY eq.serial_no
        )
        ORDER BY eq.id asc, er.reg_at DESC
        LIMIT #{index}, #{size}
    </select>
</mapper>